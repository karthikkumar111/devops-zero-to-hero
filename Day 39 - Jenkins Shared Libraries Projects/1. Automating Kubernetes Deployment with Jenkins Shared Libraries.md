## üë®‚Äçüè´ Instructor Details

| Information  | Details                                                                        |
| ------------ | ------------------------------------------------------------------------------ |
| **Name**     | Moole Muralidhara Reddy                                                        |
| **Email**    | [techworldwithmurali@gmail.com](mailto:techworldwithmurali@gmail.com)          |
| **Website**  | [techworldwithmurali.com](https://www.techworldwithmurali.com)                 |
| **LinkedIn** | [Moole Muralidhara Reddy](https://www.linkedin.com/in/moole-muralidhara-reddy) |

## **Automating Kubernetes Deployment with Jenkins Shared Libraries** 

## üìÅ Repository Information

* **Repository Name:** `user-registration-shared`
* **GitHub Owner:** `techworldwithmurali`
* **Branch:** `eks`
* **GitHub URL:** [https://github.com/techworldwithmurali/user-registration-shared.git](https://github.com/techworldwithmurali/user-registration-shared.git)

## üì¶ Purpose

This Jenkins Shared Library enables:

* Installing `kubectl`
* Connecting to an AWS EKS Cluster
* Updating Docker Image Tag in Kubernetes deployment
* Applying Kubernetes YAMLs

## üõ†Ô∏è Shared Library Structure

### üîß `vars/installKubectl.groovy`

**Function:** Installs the specified version of `kubectl` (default: 1.31.0)

```groovy
def call(String version = "1.31.0") {
    sh """
        curl -LO https://dl.k8s.io/release/v${version}/bin/linux/amd64/kubectl
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/kubectl
        kubectl version --client
    """
}
```

**Jenkinsfile Usage:**

```groovy
stage('Install Kubectl') {
    steps {
        installKubectl()
    }
}
```

### üîó `vars/connectToEks.groovy`

**Function:** Configures `kubectl` to connect with the specified EKS cluster.

```groovy
def call(String clusterName, String region) {
    sh """
        aws eks update-kubeconfig --region ${region} --name ${clusterName}
    """
}
```

**Jenkinsfile Usage:**

```groovy
stage('Connect to EKS') {
    steps {
        connectToEks(params.clusterName, params.region)
    }
}
```
### üè∑Ô∏è `vars/updateTagInDeployment.groovy`

**Function:** Replaces the `__TAG__` placeholder in deployment file with the actual image tag.

```groovy
def call(String deploymentFile, String IMAGE_TAG) {
    sh """
        sed -i 's|__TAG__|${IMAGE_TAG}|g' ${deploymentFile}
        echo "Updated ${deploymentFile} contents:"
        cat ${deploymentFile}
    """
}
```

**Jenkinsfile Usage:**

```groovy
environment {
    DEPLOYMENT_FILE = 'k8s/deployment.yaml'
}

stage('Update Image Tag in Deployment') {
    steps {
        updateTagInDeployment(env.DEPLOYMENT_FILE, params.IMAGE_TAG)
    }
}
```

### üìú `vars/applyK8sYaml.groovy`

**Function:** Applies all Kubernetes manifest files from the given directory.

```groovy
def call(String YAML_DIR) {
    sh "kubectl apply -f ${YAML_DIR}"
}
```

**Jenkinsfile Usage:**

```groovy
environment {
    YAML_DIR = 'k8s/'
}

stage('Apply Kubernetes YAMLs') {
    steps {
        applyK8sYaml(YAML_DIR)
    }
}
```

## üåê Jenkinsfile Overview

```groovy
pipeline {
    agent any

    parameters {
        string(name: 'branchName', defaultValue: 'eks', description: 'Branch name to clone')
        choice(name: 'REGION', choices: ['us-east-1','us-west-2'], description: 'Select AWS region')
        choice(name: 'CLUSTER_NAME', choices: [
            'infra-cluster', 'dev-cluster', 'test-cluster',
            'qa-cluster', 'uat-cluster', 'pre-prod-cluster', 'prod-cluster'
        ], description: 'Select cluster name')
        string(name: 'IMAGE_TAG', defaultValue: '', description: 'Docker image tag to update in the deployment YAML')
    }

    environment {
        DEPLOYMENT_FILE = 'k8s/deployment.yaml'
        YAML_DIR = 'k8s/'
    }

    stages {

        stage('Clone the repository') {
            steps {
                gitClone(params.branchName, 'github-cred', 'https://github.com/techworldwithmurali/user-registration-shared.git')
            }
        }

        stage('Install Kubectl') {
            steps {
                installKubectl()
            }
        }

        stage('Connect to EKS') {
            steps {
                connectToEks(params.clusterName, params.region)
            }
        }

        stage('Update Image Tag in Deployment') {
            steps {
                updateTagInDeployment(env.DEPLOYMENT_FILE, params.IMAGE_TAG)
            }
        }

        stage('Apply Kubernetes YAMLs') {
            steps {
                applyK8sYaml(env.YAML_DIR)
            }
        }
    }
}
```
